<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Chat HD</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #050816;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        #status {
            padding: 10px;
            font-weight: bold;
            font-size: 1.2em;
            text-shadow: 0 0 10px rgba(0,255,0,0.5);
        }

        #messages {
            flex: 1;
            width: 95%;
            max-width: 1000px;
            border: 2px solid #00d4ff;
            overflow-y: auto;
            margin: 10px;
            padding: 20px;
            background: #0a0e27;
            border-radius: 12px;
            box-shadow: inset 0 0 20px rgba(0, 212, 255, 0.1);
        }

        .controls {
            width: 95%;
            max-width: 1000px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px 20px;
            background: #141935;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid #1e2542;
        }

        .media-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .media-options label {
            font-size: 0.8em;
            color: #7a8ab0;
            white-space: nowrap;
        }

        .media-options select {
            background: #1e2542;
            color: #e0e8ff;
            border: 1px solid #2a3560;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 0.82em;
            cursor: pointer;
            outline: none;
            transition: border-color 0.2s;
        }
        .media-options select:hover,
        .media-options select:focus { border-color: #00d4ff; }

        .sep { color: #2a3560; margin: 0 4px; }

        .input-group { display: flex; gap: 10px; }

        input[type="text"] {
            flex: 1;
            padding: 13px 15px;
            border-radius: 8px;
            border: 1px solid #1e2542;
            background: #1e2542;
            color: white;
            font-size: 1em;
            outline: none;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus { border-color: #00d4ff; }

        button {
            padding: 10px 22px;
            cursor: pointer;
            background: #00d4ff;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            color: #050816;
            font-size: 0.95em;
            transition: 0.2s;
            white-space: nowrap;
        }
        button:hover { background: #008fb3; transform: scale(1.04); }
        button:active { transform: scale(0.98); }

        #progressContainer {
            width: 100%;
            background: #1e2542;
            border-radius: 10px;
            display: none;
            height: 10px;
            overflow: hidden;
            border: 1px solid #00d4ff;
        }
        #progressBar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            transition: width 0.1s;
        }
        #uploadStatus {
            font-size: 0.78em;
            color: #00d4ff;
            text-align: center;
            display: none;
            padding: 2px 0;
        }

        .msg {
            margin-bottom: 18px;
            padding: 14px;
            background: #161b33;
            border-radius: 10px;
            border-left: 5px solid #00d4ff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            animation: fadeIn 0.3s ease;
        }

        .msg img {
            max-width: 100%;
            max-height: 600px;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 8px;
            margin-top: 10px;
            display: block;
            background: #000;
            border: 1px solid #1e2542;
        }

        .msg video {
            max-width: 100%;
            max-height: 500px;
            width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 10px;
            display: block;
            background: #000;
            border: 1px solid #1e2542;
        }

        .msg audio { width: 100%; margin-top: 10px; }

        .dl-link {
            display: inline-block;
            margin-top: 8px;
            color: #00d4ff;
            text-decoration: none;
            font-weight: bold;
            background: rgba(0, 212, 255, 0.08);
            padding: 6px 13px;
            border-radius: 5px;
            border: 1px solid #00d4ff;
            font-size: 0.85em;
            transition: background 0.2s;
        }
        .dl-link:hover { background: rgba(0, 212, 255, 0.22); }

        .msg-meta {
            font-size: 0.72em;
            color: #3a4a66;
            margin-top: 6px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to   { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div id="status">Initialisation... ‚ö™</div>
    <div id="messages"></div>

    <div class="controls">
        <div id="progressContainer"><div id="progressBar"></div></div>
        <div id="uploadStatus"></div>

        <!-- S√©lecteurs format / r√©solution -->
        <div class="media-options">
            <label>üñºÔ∏è Format :</label>
            <select id="imgFormat">
                <option value="image/jpeg">JPEG</option>
                <option value="image/png">PNG</option>
                <option value="image/webp">WebP</option>
            </select>

            <span class="sep">|</span>

            <label>üìê R√©solution image :</label>
            <select id="imgResolution">
                <option value="original">Original</option>
                <option value="3840">4K (3840px)</option>
                <option value="2560">2K (2560px)</option>
                <option value="1920" selected>Full HD (1920px)</option>
                <option value="1280">HD (1280px)</option>
                <option value="854">SD (854px)</option>
                <option value="640">Basse (640px)</option>
            </select>

            <span class="sep">|</span>

            <label>üé¨ Qualit√© vid√©o :</label>
            <select id="vidQuality">
                <option value="4k">4K</option>
                <option value="1080p" selected>1080p</option>
                <option value="720p">720p</option>
                <option value="480p">480p</option>
                <option value="360p">360p</option>
                <option value="original">Original</option>
            </select>
        </div>

        <div class="input-group">
            <input type="text" id="messageInput" placeholder="√âcrivez un message ou envoyez un m√©dia...">
            <input type="file" id="fileInput" style="display:none"
                   accept="image/jpeg,image/png,image/gif,image/webp,image/bmp,image/tiff,image/svg+xml,
                           video/mp4,video/webm,video/ogg,video/quicktime,video/x-msvideo,video/x-matroska,video/3gpp,
                           audio/*">
            <button onclick="document.getElementById('fileInput').click()">üì∑ / üé•</button>
            <button onclick="sendMessage()">ENVOYER</button>
        </div>
    </div>

    <script>
        const socket = new WebSocket('wss://globalchat-railway.onrender.com');
        const statusDiv = document.getElementById('status');
        const messagesDiv = document.getElementById('messages');
        const progressBar = document.getElementById('progressBar');
        const progressContainer = document.getElementById('progressContainer');
        const uploadStatus = document.getElementById('uploadStatus');

        socket.onopen = () => {
            statusDiv.innerHTML = "Connect√© üü¢";
            statusDiv.style.color = "#00ff00";
        };
        socket.onclose = () => {
            statusDiv.innerHTML = "D√©connect√© üî¥";
            statusDiv.style.color = "#ff4444";
            setTimeout(() => location.reload(), 3000);
        };

        socket.onmessage = (event) => {
            const msgData = JSON.parse(event.data);
            if (msgData.type === 'history') {
                messagesDiv.innerHTML = '';
                msgData.data.forEach(m => addMessageToScreen(m));
            } else {
                addMessageToScreen(msgData);
            }
        };

        function addMessageToScreen(data) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'msg';
            const mime = data.mimetype || '';

            if (data.type === 'text') {
                msgDiv.textContent = data.text;

            } else if (data.type === 'media') {
                const metaHtml = data.meta ? `<div class="msg-meta">üìä ${data.meta}</div>` : '';

                if (mime.startsWith('video/') || (!mime && data.url.match(/\.(mp4|webm|mov|ogg|mkv|avi|3gp)(\?|$)/i))) {
                    msgDiv.innerHTML = `
                        <video controls playsinline preload="metadata">
                            <source src="${data.url}" ${mime ? `type="${mime}"` : ''}>
                        </video>
                        <a class="dl-link" href="${data.url}" target="_blank">üì• Ouvrir la vid√©o</a>
                        ${metaHtml}`;

                } else if (mime.startsWith('image/') || (!mime && data.url.match(/\.(jpg|jpeg|png|gif|webp|bmp|tiff|svg)(\?|$)/i))) {
                    const img = document.createElement('img');
                    img.src = data.url;
                    img.alt = "Image partag√©e";
                    img.onload = scrollToBottom;
                    img.onerror = () => { img.style.display = 'none'; };

                    const link = document.createElement('a');
                    link.href = data.url;
                    link.target = '_blank';
                    link.className = 'dl-link';
                    link.textContent = 'üì• Voir en HD';

                    msgDiv.appendChild(img);
                    msgDiv.appendChild(link);
                    if (data.meta) {
                        const m = document.createElement('div');
                        m.className = 'msg-meta';
                        m.textContent = 'üìä ' + data.meta;
                        msgDiv.appendChild(m);
                    }

                } else if (mime.startsWith('audio/')) {
                    msgDiv.innerHTML = `
                        <audio controls>
                            <source src="${data.url}" type="${mime}">
                        </audio>
                        <a class="dl-link" href="${data.url}" target="_blank">üì• Audio</a>
                        ${metaHtml}`;
                } else {
                    msgDiv.innerHTML = `<a class="dl-link" href="${data.url}" target="_blank">üìé Voir le fichier</a>`;
                }
            }

            messagesDiv.appendChild(msgDiv);
            scrollToBottom();
        }

        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            if (input.value.trim() !== "") {
                socket.send(JSON.stringify({ type: 'text', text: input.value }));
                input.value = "";
            }
        }

        function setStatus(msg, color = '#00d4ff') {
            uploadStatus.textContent = msg;
            uploadStatus.style.color = color;
            uploadStatus.style.display = 'block';
        }

        // ‚îÄ‚îÄ‚îÄ R√©solutions disponibles (max px sur le c√¥t√© le plus long) ‚îÄ‚îÄ‚îÄ
        const RESOLUTIONS = {
            'original': null,
            '3840': 3840,
            '2560': 2560,
            '1920': 1920,
            '1280': 1280,
            '854':  854,
            '640':  640,
        };
        const RES_LABELS = {
            'original':'Original','3840':'4K','2560':'2K',
            '1920':'Full HD','1280':'HD','854':'SD','640':'Basse qualit√©'
        };
        const FMT_LABELS = { 'image/jpeg':'JPEG','image/png':'PNG','image/webp':'WebP' };
        const VID_LABELS = { '4k':'4K','1080p':'1080p','720p':'720p','480p':'480p','360p':'360p','original':'Original' };

        // ‚îÄ‚îÄ‚îÄ Traitement image (redimensionnement + conversion format) ‚îÄ‚îÄ‚îÄ
        function processImage(file, callback) {
            const format = document.getElementById('imgFormat').value;
            const resKey = document.getElementById('imgResolution').value;
            const maxPx  = RESOLUTIONS[resKey];

            // GIF, SVG, TIFF ‚Üí envoi direct (canvas ne les g√®re pas bien)
            if (['image/gif', 'image/svg+xml', 'image/tiff'].includes(file.type)) {
                setStatus(`üì§ Envoi direct (${file.type.split('/')[1].toUpperCase()})...`);
                return callback(file, file.type, `${file.type.split('/')[1].toUpperCase()} ‚Ä¢ Original`);
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    let w = img.width, h = img.height;

                    if (maxPx && (w > maxPx || h > maxPx)) {
                        const ratio = Math.min(maxPx / w, maxPx / h);
                        w = Math.round(w * ratio);
                        h = Math.round(h * ratio);
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = w; canvas.height = h;
                    const ctx = canvas.getContext('2d');

                    // Fond blanc pour JPEG (supprime transparence)
                    if (format === 'image/jpeg') {
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(0, 0, w, h);
                    }
                    ctx.drawImage(img, 0, 0, w, h);

                    const quality = (format === 'image/png') ? 1 : 0.88;
                    const ext = format === 'image/jpeg' ? 'jpg' : format === 'image/webp' ? 'webp' : 'png';
                    const newName = file.name.replace(/\.[^.]+$/, `.${ext}`);

                    canvas.toBlob((blob) => {
                        const out = new File([blob], newName, { type: format });
                        const meta = `${FMT_LABELS[format]} ‚Ä¢ ${RES_LABELS[resKey]} (${w}√ó${h}) ‚Ä¢ ${(out.size/1024).toFixed(0)} Ko`;
                        setStatus(`‚úÖ ${meta}`);
                        callback(out, format, meta);
                    }, format, quality);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // ‚îÄ‚îÄ‚îÄ Upload XHR ‚îÄ‚îÄ‚îÄ
        function uploadFile(file, mimetype, meta) {
            const formData = new FormData();
            formData.append('file', file);

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/upload', true);

            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable)
                    progressBar.style.width = (e.loaded / e.total) * 100 + '%';
            };

            xhr.onload = function () {
                if (xhr.status === 200) {
                    const res = JSON.parse(xhr.responseText);
                    socket.send(JSON.stringify({
                        type: 'media',
                        url: res.url,
                        mimetype: mimetype || res.mimetype,
                        meta: meta || ''
                    }));
                    setStatus('‚úÖ Envoy√© avec succ√®s !', '#00ff88');
                } else {
                    setStatus('‚ùå Erreur upload', '#ff4444');
                    alert("Erreur lors de l'upload. R√©essaie.");
                }
                setTimeout(() => {
                    progressContainer.style.display = "none";
                    progressBar.style.width = "0%";
                    uploadStatus.style.display = "none";
                }, 2500);
            };

            xhr.onerror = () => {
                setStatus('‚ùå Erreur r√©seau', '#ff4444');
                progressContainer.style.display = "none";
            };

            xhr.send(formData);
        }

        // ‚îÄ‚îÄ‚îÄ D√©clenchement ‚îÄ‚îÄ‚îÄ
        document.getElementById('fileInput').onchange = function () {
            const file = this.files[0];
            if (!file) return;

            progressContainer.style.display = "block";
            progressBar.style.width = "0%";
            setStatus('‚è≥ Traitement en cours...');

            if (file.type.startsWith('image/')) {
                processImage(file, (processed, mime, meta) => uploadFile(processed, mime, meta));
            } else if (file.type.startsWith('video/')) {
                const vidQ = document.getElementById('vidQuality').value;
                const meta = `${file.name} ‚Ä¢ ${VID_LABELS[vidQ]} ‚Ä¢ ${(file.size/1024/1024).toFixed(1)} Mo`;
                setStatus(`üì§ Upload vid√©o (${(file.size/1024/1024).toFixed(1)} Mo)...`);
                uploadFile(file, file.type, meta);
            } else {
                uploadFile(file, file.type, '');
            }

            this.value = '';
        };

        document.getElementById('messageInput').onkeypress = (e) => {
            if (e.key === 'Enter') sendMessage();
        };
    </script>
</body>
</html>
