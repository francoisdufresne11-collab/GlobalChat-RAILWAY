<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Chat HD</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #050816;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        #status {
            padding: 10px;
            font-weight: bold;
            font-size: 1.2em;
            text-shadow: 0 0 10px rgba(0,255,0,0.5);
        }

        #messages {
            flex: 1;
            width: 95%;
            max-width: 1000px;
            border: 2px solid #00d4ff;
            overflow-y: auto;
            margin: 10px;
            padding: 20px;
            background: #0a0e27;
            border-radius: 12px;
            box-shadow: inset 0 0 20px rgba(0, 212, 255, 0.1);
        }

        .controls {
            width: 95%;
            max-width: 1000px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 20px;
            background: #141935;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid #1e2542;
        }

        .input-group { display: flex; gap: 10px; }

        input[type="text"] {
            flex: 1;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #1e2542;
            background: #1e2542;
            color: white;
            font-size: 1em;
            outline: none;
        }

        button {
            padding: 10px 25px;
            cursor: pointer;
            background: #00d4ff;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            color: #050816;
            font-size: 1em;
            transition: 0.3s;
        }
        button:hover { background: #008fb3; transform: scale(1.05); }

        #progressContainer {
            width: 100%;
            background: #1e2542;
            border-radius: 10px;
            display: none;
            height: 12px;
            overflow: hidden;
            border: 1px solid #00d4ff;
        }
        #progressBar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #00ff00);
            transition: width 0.1s;
        }

        .msg {
            margin-bottom: 20px;
            padding: 15px;
            background: #161b33;
            border-radius: 10px;
            border-left: 5px solid #00d4ff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            animation: fadeIn 0.3s ease;
        }

        /* âœ… Images et vidÃ©os bien visibles */
        .msg img {
            max-width: 100%;
            max-height: 600px;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 10px;
            margin-top: 10px;
            display: block;
            background: #000;
            border: 1px solid #1e2542;
        }

        .msg video {
            max-width: 100%;
            max-height: 500px;
            width: 100%;
            height: auto;
            border-radius: 10px;
            margin-top: 10px;
            display: block;
            background: #000;
            border: 1px solid #1e2542;
        }

        .msg audio {
            width: 100%;
            margin-top: 10px;
        }

        .dl-link {
            display: inline-block;
            margin-top: 10px;
            color: #00d4ff;
            text-decoration: none;
            font-weight: bold;
            background: rgba(0, 212, 255, 0.1);
            padding: 8px 15px;
            border-radius: 5px;
            border: 1px solid #00d4ff;
            font-size: 0.9em;
        }
        .dl-link:hover { background: rgba(0, 212, 255, 0.25); }

        .upload-label {
            font-size: 0.85em;
            color: #aaa;
            text-align: center;
            padding-top: 4px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to   { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div id="status">Initialisation... âšª</div>
    <div id="messages"></div>
    <div class="controls">
        <div id="progressContainer"><div id="progressBar"></div></div>
        <div class="input-group">
            <input type="text" id="messageInput" placeholder="Ã‰crivez un message ou envoyez un mÃ©dia...">
            <input type="file" id="fileInput" style="display:none" accept="image/*,video/*,audio/*">
            <button onclick="document.getElementById('fileInput').click()">ðŸ“· / ðŸŽ¥</button>
            <button onclick="sendMessage()">ENVOYER</button>
        </div>
        <div class="upload-label">Images, vidÃ©os et audio acceptÃ©s</div>
    </div>

    <script>
        const socket = new WebSocket('wss://globalchat-railway.onrender.com');
        const statusDiv = document.getElementById('status');
        const messagesDiv = document.getElementById('messages');
        const progressBar = document.getElementById('progressBar');
        const progressContainer = document.getElementById('progressContainer');

        socket.onopen = () => {
            statusDiv.innerHTML = "ConnectÃ© ðŸŸ¢";
            statusDiv.style.color = "#00ff00";
        };
        socket.onclose = () => {
            statusDiv.innerHTML = "DÃ©connectÃ© ðŸ”´";
            statusDiv.style.color = "#ff4444";
            setTimeout(() => location.reload(), 3000);
        };

        socket.onmessage = (event) => {
            const msgData = JSON.parse(event.data);
            if (msgData.type === 'history') {
                messagesDiv.innerHTML = '';
                msgData.data.forEach(m => addMessageToScreen(m));
            } else {
                addMessageToScreen(msgData);
            }
        };

        function addMessageToScreen(data) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'msg';

            if (data.type === 'text') {
                msgDiv.textContent = data.text;

            } else if (data.type === 'media') {
                const mime = data.mimetype || '';

                // âœ… DÃ©tection fiable par mimetype (prioritÃ©) puis fallback URL
                if (mime.startsWith('video/') || (!mime && data.url.match(/\.(mp4|webm|mov|ogg|mkv)(\?|$)/i))) {
                    msgDiv.innerHTML = `
                        <video controls playsinline preload="metadata">
                            <source src="${data.url}" ${mime ? `type="${mime}"` : ''}>
                            Votre navigateur ne supporte pas la lecture vidÃ©o.
                        </video>
                        <a class="dl-link" href="${data.url}" target="_blank">ðŸ“¥ Ouvrir la vidÃ©o</a>`;

                } else if (mime.startsWith('image/') || (!mime && data.url.match(/\.(jpg|jpeg|png|gif|webp|bmp)(\?|$)/i))) {
                    const img = document.createElement('img');
                    img.src = data.url;
                    img.alt = "Image partagÃ©e";
                    img.onload = scrollToBottom;
                    img.onerror = () => { img.style.display = 'none'; };

                    const link = document.createElement('a');
                    link.href = data.url;
                    link.target = '_blank';
                    link.className = 'dl-link';
                    link.textContent = 'ðŸ“¥ Voir en HD';

                    msgDiv.appendChild(img);
                    msgDiv.appendChild(link);

                } else if (mime.startsWith('audio/')) {
                    msgDiv.innerHTML = `
                        <audio controls>
                            <source src="${data.url}" type="${mime}">
                        </audio>
                        <a class="dl-link" href="${data.url}" target="_blank">ðŸ“¥ TÃ©lÃ©charger l'audio</a>`;

                } else {
                    // Fallback gÃ©nÃ©rique
                    msgDiv.innerHTML = `<a class="dl-link" href="${data.url}" target="_blank">ðŸ“Ž Voir le fichier</a>`;
                }
            }

            messagesDiv.appendChild(msgDiv);
            scrollToBottom();
        }

        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            if (input.value.trim() !== "") {
                socket.send(JSON.stringify({ type: 'text', text: input.value }));
                input.value = "";
            }
        }

        document.getElementById('fileInput').onchange = function () {
            const file = this.files[0];
            if (!file) return;

            progressContainer.style.display = "block";
            progressBar.style.width = "0%";

            const formData = new FormData();
            formData.append('file', file);

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/upload', true);

            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    progressBar.style.width = (e.loaded / e.total) * 100 + '%';
                }
            };

            xhr.onload = function () {
                if (xhr.status === 200) {
                    const res = JSON.parse(xhr.responseText);
                    // âœ… On envoie le mimetype avec le message media
                    socket.send(JSON.stringify({
                        type: 'media',
                        url: res.url,
                        mimetype: res.mimetype
                    }));
                } else {
                    alert("Erreur lors de l'upload. RÃ©essaie.");
                }
                setTimeout(() => {
                    progressContainer.style.display = "none";
                    progressBar.style.width = "0%";
                }, 1000);
            };

            xhr.onerror = () => {
                alert("Erreur rÃ©seau lors de l'upload.");
                progressContainer.style.display = "none";
            };

            xhr.send(formData);
            this.value = ''; // Reset pour pouvoir renvoyer le mÃªme fichier
        };

        document.getElementById('messageInput').onkeypress = (e) => {
            if (e.key === 'Enter') sendMessage();
        };
    </script>
</body>
</html>
